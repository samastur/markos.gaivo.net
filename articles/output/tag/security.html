<!DOCTYPE html>
<html lang="en">
<head>
        <title>A notch above a monkey - Security</title>
        <meta charset="utf-8" />
        <link rel="shortcut icon" href="theme/img/markos.ico" />

        <link rel="stylesheet" type="text/css" href="theme/css/home.min.css" media="screen" title="Light theme" />
        <link rel="alternate stylesheet" type="text/css" href="theme/css/home_dark.min.css" media="screen" title="Dark theme" />

        <link href="/articles/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="A notch above a monkey Full Atom Feed" />
        <link href="/articles/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="A notch above a monkey Full RSS Feed" />
</head>

<body>


<section class="envelope posts">
    <header>
        <h1><a href="../">A notch above a monkey <strong></strong></a></h1>
    </header><!-- /#banner -->

    <nav class="colophon">
        <h1>By Marko Samastur</h1>
        <ul>
            <li><a href="/">About me</a></li>
            <li><a href="/articles/feeds/atom.xml">Subscribe</a></li>
        </ul>
    </nav>

        <article class="hentry">
            <h1 class="entry-title storytitle"><a href="../laughable-javascript-security.html" rel="bookmark" title="Permalink to Laughable Javascript security">Laughable Javascript security</a></h1>

            <div class="entry-content post-text">
                <div>
 <p>
  Building a secure web application is not easy, unless you also use 3rd party code such as Facebook’s Like widget in which case it is impossible. What you have is just an illusion of security, a door to abuse that you can’t even check if it is currently closed.
 </p>
 <p>
  Or that’s what I thought for years. A once substantiated belief that grew into an almost dogmatic certainty until I recently got a chance to revisit it when trying to design a secure Javascript-based web application living inside of a likely untrusted environment.
 </p>
 <p>
  There are obvious things you can do to protect your application such as delivery over secure connections and use of anonymous functions to sandbox your code from outside interference. However you will probably need to interact with external code at some point in which case is that
  <em>
   XMLHTTPRequest
  </em>
  object you are using really the built-in one or has it been replaced (cloaked) with an impostor object to perform
  <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">
   the man-in-the-middle attack
  </a>
  ?
 </p>
 <p>
  I don’t know of a way to check if an object is untouched. What is sometimes used instead is a
  <em>
   .toString
  </em>
  method which on functions and methods returns their source unless they are native to browser in which case it returns a string saying so.
 </p>
 <p>
  Since you can replace any attribute and method on any object some
  <a href="http://stackoverflow.com/questions/6598945/detect-if-function-is-native-to-browser#comment8044242_6599105">
   go even further
  </a>
  in search of a certainty and use
  <em>
   .toString
  </em>
  from the
  <em>
   Function
  </em>
  object.
 </p>
 <p>
  At first thought that looked clever until I came up with:
 </p>
 <ol class="code">
  <li>
   <code>
    &lt;!DOCTYPE HTML&gt;
   </code>
  </li>
  <li>
   <code>
    &lt;html lang="en"&gt;
   </code>
  </li>
  <li>
   <code>
    &lt;head&gt;
   </code>
  </li>
  <li class="tab1">
   <code>
    &lt;meta charset="UTF-8"&gt;
   </code>
  </li>
  <li class="tab1">
   <code>
    &lt;title&gt;Break check if function is native&lt;/title&gt;
   </code>
  </li>
  <li>
   <code>
    &lt;/head&gt;
   </code>
  </li>
  <li>
   <code>
    &lt;body&gt;
   </code>
  </li>
  <li class="tab1">
   <code>
    &lt;script&gt;
   </code>
  </li>
  <li>
   <code>
    (function () {
   </code>
  </li>
  <li class="tab1">
   <code>
    var toS = Function.prototype.toString,
   </code>
  </li>
  <li class="tab2">
   <code>
    pM_str = window.postMessage.toString();
   </code>
  </li>
  <li>
  </li>
  <li class="tab1">
   <code>
    Function.prototype.toString = function () {
   </code>
  </li>
  <li class="tab2">
   <code>
    return this === window.postMessage ? pM_str : toS.call(this);
   </code>
  </li>
  <li class="tab1">
   <code>
    }
   </code>
  </li>
  <li class="tab1">
   <code>
    window.postMessage = function () { console.log('Fake'); };
   </code>
  </li>
  <li>
   <code>
    })();
   </code>
  </li>
  <li class="tab1">
   <code>
    &lt;/script&gt;
   </code>
  </li>
  <li>
   <code>
    &lt;/body&gt;
   </code>
  </li>
  <li>
   <code>
    &lt;/html&gt;
   </code>
  </li>
  <li>
  </li>
  <li class="download">
   Download this code:
   <a href="http://markos.gaivo.net/blog/code/nativecheck.txt" title="Download the above code as a text file">
    /code/nativecheck.txt
   </a>
  </li>
 </ol>
 <p>
  The code above replaces
  <em>
   Function’s .toString
  </em>
  method with a one that lies when executed on an also cloaked
  <em>
   window.postMessage
  </em>
  . Instead of displaying source of the new
  <em>
   postMessage
  </em>
  it prints whatever browser would print for the original one.
 </p>
 <p>
  It simultaneously demonstrates how you can cloak native Javascript objects and hide that you are doing it. If you put malicious code into an anonymous function and remove
  <em>
   &lt;script&gt;
  </em>
  node that added it after it gets executed, then there is no way for scripts loading later to know that it happened. There will be no traces of crime.
 </p>
 <p>
  It might be difficult to cloak literals like {} and [], but you certainly can their methods so even if your code is wrapped in an anonymous function, it isn’t really secured from outside peeking and poking. Hence you even
  <strong>
   can’t trust your own code
  </strong>
  .
 </p>
 <p>
  Turns out that this particular dogma is also true. Depressing.
 </p>
</div>
            </div><!-- /.entry-content -->

            <footer class="post-metadata">
                <ul>
                    <li>Published on <time datetime="2013-07-11T22:57:00+02:00">Thu 11 July 2013</time> </li>
                    <li><a href="../laughable-javascript-security.html">Add your comment</a></li>
                </ul>
            </footer>
        </article>
        <article class="hentry">
            <h1 class="entry-title storytitle"><a href="../prism.html" rel="bookmark" title="Permalink to Prism">Prism</a></h1>

            <div class="entry-content post-text">
                <div>
 <p>
  Only brains twisted in a pretzel can be completely fine with sweeping lightly-overseen secret surveillance of society, but feel personal freedoms are tyrannically trampled when soda cups are limited to sizes smaller than a bucket or when city bikes are introduced.
 </p>
 <p>
  Whoever thinks losing privacy is fine because he has nothing to hide, is either seriously lacking imagination, an idiot or both.
 </p>
</div>
            </div><!-- /.entry-content -->

            <footer class="post-metadata">
                <ul>
                    <li>Published on <time datetime="2013-06-09T23:11:00+02:00">Sun 09 June 2013</time> </li>
                    <li><a href="../prism.html">Add your comment</a></li>
                </ul>
            </footer>
        </article>
        <article class="hentry">
            <h1 class="entry-title storytitle"><a href="../impostor-for-django.html" rel="bookmark" title="Permalink to Impostor for Django">Impostor for Django</a></h1>

            <div class="entry-content post-text">
                <div>
 <p>
  A class of bugs I really dislike debugging are those that depend on specific data and affect only a very small subset or just one user. Things could sometimes be fixed so much faster if you could just log in as him to see what is happening. Sometimes this is exactly what we do
  <strong>
   with his explicit permission
  </strong>
  , but I really dislike asking for passwords.
 </p>
 <p>
  First it inconveniences user. He has to come up with either a new good password or go through two password changes. Second it implicitly teaches wrong behavior. Passwords simply should never be revealed.
 </p>
 <p>
  That is why I wrote
  <a href="https://github.com/samastur/Impostor" title="Impostor's home at GitHub">
   Impostor
  </a>
  , a Django app that allows staff members (and only them) to login with their own credentials as a different user. Idea is not mine (kudos goes to
  <a href="http://nedbatchelder.com/blog/201008/django_superuser_login_trapdoor.html" title="Ned's post where idea comes from">
   Ned Batchelder
  </a>
  ), but I like it. To discourage abuse every such authentication is recorded and can be seen in Django admin interface, but can not be altered from there.
 </p>
 <p>
  So how does it work in practice?
 </p>
 <p>
  Lets say that I would need to log in as user
  <em>
   fry
  </em>
  . To do this I would enter as my username
  <em>
   markos as fry,
  </em>
  provide my password and voila, I’m him. This has been recorded so anyone with access to ImpostorLog part in admin can see all such cases, mine included.
 </p>
 <p>
  Impostor may also ease your development by removing need to remember different passwords for testing. This is usually not a problem unless you happen to develop with fake data but real accounts. Like me.
 </p>
 <p>
  And again for morally challenged out there:
  <strong>
   you should never login as somebody else without his explicit permission
  </strong>
  .
 </p>
 <p>
  <strong>
   Update
  </strong>
  : Thanks Ross for reminding me where idea came from. I updated text accordingly.
 </p>
 <div class="zemanta-pixie">
  <a class="zemanta-pixie-a" href="http://www.zemanta.com/" title="Enhanced by Zemanta">
   <img alt="Enhanced by Zemanta" class="zemanta-pixie-img" src="http://img.zemanta.com/zemified_e.png?x-id=db7c9f53-423e-4b56-bbe3-b717fde54c16"/>
  </a>
 </div>
</div>
            </div><!-- /.entry-content -->

            <footer class="post-metadata">
                <ul>
                    <li>Published on <time datetime="2011-02-22T20:11:00+01:00">Tue 22 February 2011</time> </li>
                    <li><a href="../impostor-for-django.html">Add your comment</a></li>
                </ul>
            </footer>
        </article>

<p class="paginator">
    Page 1 / 1
</p>
</section><!-- /#content -->

    <footer>
        <ul>
            <li>&copy; 2005-2015 Marko Samastur</li>
            <li><a href="/articles/feeds/rss.xml" rel="alternate" title="A notch above a monkey Full RSS Feed">Entries feed</a></li>
        </ul>
        <a href="/"><img src="/img/markos_light_small_bg.png" alt="logo" class="mini-logo" /></a>
    </footer>
</body>
</html>